<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google-translate-customization" content="108d9124921d80c3-80e20d618ff053c8-g4f02ec6f3dba68b7-c"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Developing a Metasploit Alternative - Catsploit | MarkR Cybersecurity Blog</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="Developing a Metasploit Alternative - Catsploit" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In an attempt to build a new open-source cybersecurity tool for my own usage and to build some experience, I developed Catsploit. Catsploit is an exploitation framework inspired by Metasploit. This post relates to the code itself, especially the modular requirements for an exploit framework, and discusses why Metasploit will probably remain king as the go-to open-source generalist exploit framework." />
<meta property="og:description" content="In an attempt to build a new open-source cybersecurity tool for my own usage and to build some experience, I developed Catsploit. Catsploit is an exploitation framework inspired by Metasploit. This post relates to the code itself, especially the modular requirements for an exploit framework, and discusses why Metasploit will probably remain king as the go-to open-source generalist exploit framework." />
<link rel="canonical" href="http://localhost:4000/markdown/2023/05/07/developing-a-metasploit-alternative-catsploit.html" />
<meta property="og:url" content="http://localhost:4000/markdown/2023/05/07/developing-a-metasploit-alternative-catsploit.html" />
<meta property="og:site_name" content="MarkR Cybersecurity Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-05-07T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Developing a Metasploit Alternative - Catsploit" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-07T00:00:00+01:00","datePublished":"2023-05-07T00:00:00+01:00","description":"In an attempt to build a new open-source cybersecurity tool for my own usage and to build some experience, I developed Catsploit. Catsploit is an exploitation framework inspired by Metasploit. This post relates to the code itself, especially the modular requirements for an exploit framework, and discusses why Metasploit will probably remain king as the go-to open-source generalist exploit framework.","headline":"Developing a Metasploit Alternative - Catsploit","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/markdown/2023/05/07/developing-a-metasploit-alternative-catsploit.html"},"url":"http://localhost:4000/markdown/2023/05/07/developing-a-metasploit-alternative-catsploit.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="icon" href="">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-noto-sans@0.0.72/index.min.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="MarkR Cybersecurity Blog" /><link rel="stylesheet"
      href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/default.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
<!-- and it's easy to individually load additional languages -->
<script charset="UTF-8"
        src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/languages/go.min.js"></script>



















<script>
// Init highlight js
document.addEventListener('DOMContentLoaded', function(event) {
  var els = document.querySelectorAll('pre code')

  function addLangData(block) {
    var outer = block.parentElement.parentElement.parentElement;
    var lang = block.getAttribute('data-lang');
    for (var i = 0; i < outer.classList.length; i++) {
      var cls = outer.classList[i];
      if (cls.startsWith('language-')) {
        lang = cls;
        break;
      }
    }
    if (!lang) {
      cls = block.getAttribute('class');
      lang = cls ? cls.replace('hljs ', '') : '';
    }
    if (lang.startsWith('language-')) {
      lang = lang.substr(9);
    }
    block.setAttribute('class', 'hljs ' + lang);
    block.parentNode.setAttribute('data-lang', lang);
  }

  function addBadge(block) {
    var enabled = ('true' || 'true').toLowerCase();
    if (enabled == 'true') {
      var pre = block.parentElement;
      pre.classList.add('badge');
    }
  }

  function handle(block) {
    addLangData(block);
    addBadge(block)
    hljs.highlightBlock(block);
  }

  for (var i = 0; i < els.length; i++) {
    var el = els[i];
    handle(el);
  }
});
</script>

<style>
  /* code language badge */
  pre.badge::before {
    content: attr(data-lang);
    color: #fff;
    background-color: #ff4e00;
    padding: 0 .5em;
    border-radius: 0 2px;
    text-transform: uppercase;
    text-align: center;
    min-width: 32px;
    display: inline-block;
    position: absolute;
    right: 0;
  }

  /* fix wrong badge display for firefox browser */
  code > table pre::before {
    display: none;
  }
</style>
</head>
<body>



























































































































<header class="site-header " role="banner">

  <div class="wrapper">
    <div class="site-header-inner"><span class="site-brand"><a class="site-brand-inner" rel="author" href="/">
  <img class="site-favicon" title="MarkR Cybersecurity Blog" src="" onerror="this.style.display='none'">
  MarkR Cybersecurity Blog
</a>
</span><nav class="site-nav">
          <input type="checkbox" id="nav-trigger" class="nav-trigger" />
          <label for="nav-trigger">
            <span class="menu-icon">
              <svg viewBox="0 0 18 15" width="18px" height="15px">
                <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
              </svg>
            </span>
          </label>

          <div class="trigger">




</div>
        </nav></div>
  </div>
</header>

<script>
  function initHeader() {
    var lastScrollY = getScrollPos().y;
    var documentElement = document.documentElement;

    function storeScrollData() {
      var y = getScrollPos().y;var scrollStatus = "";

      if (y <= 0) {
        scrollStatus = "top";
      } else if ((window.innerHeight + y) >= document.body.offsetHeight) {
        scrollStatus = "bottom";
      } else {
        var isScrollDown = (y - lastScrollY > 0) ? true : false;
        scrollStatus = isScrollDown ? "down" : "up";
      }

      lastScrollY = y;
      documentElement.setAttribute("data-scroll-status", scrollStatus);
    }

    window.addEventListener('scroll', function(e) {
      storeScrollData();
    });

    storeScrollData();
  }
  document.addEventListener('DOMContentLoaded', initHeader);
</script>
















































































































































<script>
  function hashLocate(hashValue) {
    hashValue = hashValue.replace(/^.*#h-/, '');
    hashValue = decodeURIComponent(hashValue);
    var element = document.getElementById(hashValue);

    if (!element) {
      return;
    }

    var header = document.querySelector('header.site-header');
    var headerRect = header.getBoundingClientRect();
    var headerTop = Math.floor(headerRect.top);
    var headerHeight = Math.floor(headerRect.height);
    var scrollPos = getScrollPos();
    var offsetY = element.offsetTop - (headerTop + headerHeight + 20);

    if (offsetY == scrollPos.y) {
      return;
    }

    if (headerTop == 0  && offsetY > scrollPos.y) {
      offsetY += headerHeight + 2;
    } else if (headerTop < 0  && offsetY < scrollPos.y) {
      offsetY -= headerHeight - 2;
    }

    smoothScrollTo(offsetY);
  }

  // The first event occurred
  window.addEventListener('load', function(event) {
    if (window.location.hash) {
      hashLocate(window.location.hash);
    }
  });

  // The first event occurred
  window.addEventListener('click', function(event) {
    if (event.target.tagName.toLowerCase() == 'a') {
      hashLocate(event.target.getAttribute('href'));
    }
  });
</script>
<div class="theme-toggle">
  <input type="checkbox" id="theme-switch">
  <label for="theme-switch">
    <div class="toggle"></div>
    <div class="names">
      <p class="light">Light</p>
      <p class="dark">Dark</p>
    </div>
  </label>
</div>




<script>
  (function() {
    var sw = document.getElementById('theme-switch');
    var html = document.getElementsByTagName('html')[0];
    var nightModeOption = ('on' || 'auto').toLowerCase();
    var storage = nightModeOption === 'manual'
        ? localStorage
        : sessionStorage;
    var themeData = loadThemeData();

    function saveThemeData(data) {
      storage.setItem('theme', JSON.stringify(data));
    }

    function loadThemeData() {
      var data = storage.getItem('theme');
      try {
        data = JSON.parse(data ? data : '');
      } catch(e) {
        data = { nightShift: undefined, autoToggleAt: 0 };
        saveThemeData(data);
      }
      return data;
    }

    function handleThemeToggle(nightShift) {
      themeData.nightShift = nightShift;
      saveThemeData(themeData);
      html.dataset.theme = nightShift ? 'dark' : 'light';
      setTimeout(function() {
        sw.checked = nightShift ? true : false;
      }, 50);
    }

    function autoThemeToggle() {
      // Next time point of theme toggle
      var now = new Date();
      var toggleAt = new Date();
      var hours = now.getHours();
      var nightShift = hours >= 19 || hours <=7;

      if (nightShift) {
        if (hours > 7) {
          toggleAt.setDate(toggleAt.getDate() + 1);
        }
        toggleAt.setHours(7);
      } else {
        toggleAt.setHours(19);
      }

      toggleAt.setMinutes(0);
      toggleAt.setSeconds(0);
      toggleAt.setMilliseconds(0)

      var delay = toggleAt.getTime() - now.getTime();

      // auto toggle theme mode
      setTimeout(function() {
        handleThemeToggle(!nightShift);
      }, delay);

      return {
        nightShift: nightShift,
        toggleAt: toggleAt.getTime()
      };
    }

    // Listen the theme toggle event
    sw.addEventListener('change', function(event) {
      handleThemeToggle(event.target.checked);
    });

    if (nightModeOption == 'auto') {
      var data = autoThemeToggle();

      // Toggle theme by local setting
      if (data.toggleAt > themeData.autoToggleAt) {
        themeData.autoToggleAt = data.toggleAt;
        handleThemeToggle(data.nightShift);
      } else {
        handleThemeToggle(themeData.nightShift);
      }
    } else if (nightModeOption == 'manual') {
      handleThemeToggle(themeData.nightShift);
    } else {
      var nightShift = themeData.nightShift;
      if (nightShift === undefined) {
        nightShift = nightModeOption === 'on';
      }
      handleThemeToggle(nightShift);
    }
  })();
</script>
<div id="click-to-top" class="click-to-top">
  <i class="fa fa-arrow-up"></i>
</div>
<script>
  (function () {
    const clickToTop = document.getElementById('click-to-top');
    window.addEventListener('scroll', () => {
      if (window.scrollY > 100) {
        clickToTop.classList.add('show')
      }else {
        clickToTop.classList.remove('show')
      }
    });
    clickToTop.addEventListener('click', () => {
      window.smoothScrollTo(0);
    });
  })();
</script>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <div class="framework">
  <section class="main">

     <div class="post">
  <section>









<header class="post-header">
  <h1 class="post-title p-name" itemprop="name headline">Developing a Metasploit Alternative - Catsploit</h1>
  <h2 class="post-subtitle"></h2>

  <p class="post-meta">
    <time class="dt-published" datetime="2023-05-07T00:00:00+01:00" itemprop="datePublished"><i class="fa fa-calendar"></i> May 7, 2023
    </time>

    
    
































    <span class="post-reading-time left-vsplit"><i class="fa fa-clock-o"></i> About 23 mins</span>
  </p></header>
<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

    <div class="post-content e-content" itemprop="articleBody">

      <p>In an attempt to build a new open-source cybersecurity tool for my own usage and to build some experience, I developed <a href="https://github.com/mark-ruddy/catsploit">Catsploit</a>. Catsploit is an exploitation framework inspired by <a href="https://github.com/rapid7/metasploit-framework">Metasploit</a>. This post relates to the code itself, especially the modular requirements for an exploit framework, and discusses why Metasploit will probably remain king as the go-to open-source generalist exploit framework.</p>

<h2 id="catsploit-development">Catsploit development</h2>
<h3 id="structure">Structure</h3>

<p>Source code: https://github.com/mark-ruddy/catsploit
Catsploit is layed out in a common format of a separate library to application/interface:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[main][~/dev/default/catsploit]$ tree -L 2   
.
├── catsploit
│   ├── Cargo.lock
│   ├── Cargo.toml
│   ├── src
│   └── target
├── catsploit_lib
│   ├── Cargo.lock
│   ├── Cargo.toml
│   ├── README.md
│   ├── src
│   └── target
├── LICENSE
└── README.md

7 directories, 7 files
[main][~/dev/default/catsploit]$ 
</code></pre></div></div>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">catsploit</code> directory contains only the code to create the CLI app, such as the user input loop and dealing with setting module options. <code class="language-plaintext highlighter-rouge">catsploit</code> interacts with the <code class="language-plaintext highlighter-rouge">catsploit_lib</code> library</li>
  <li>The <code class="language-plaintext highlighter-rouge">catsploit_lib</code> directory contains the library. <code class="language-plaintext highlighter-rouge">catsploit_lib</code> contains the functional code for carrying out tasks with Catsploit. For example the <code class="language-plaintext highlighter-rouge">Exploit</code> trait and also the individual modules such as the <code class="language-plaintext highlighter-rouge">Vsftpd234Backdoor</code> exploit</li>
</ul>

<p>This structure of a split between the CLI app and the library allows other custom applications to hook into <code class="language-plaintext highlighter-rouge">catsploit_lib</code> and use its functionality. For example an <code class="language-plaintext highlighter-rouge">axum</code> server could be written in the future to allow calling of <code class="language-plaintext highlighter-rouge">catsploit_lib</code> code from a website.</p>

<h4 id="separate-library-and-application">Separate library and application</h4>

<p>During local development, the <code class="language-plaintext highlighter-rouge">Cargo.toml</code> of the application that is hooking into the library can be set to <code class="language-plaintext highlighter-rouge">path</code>. When hosting the crate of the application on <a href="https://crates.io/">crates.io</a> though, it must be a version number that is another crate hosted on crates.io:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[dependencies]
# NOTE: when doing local development on CLI with changes to library, can change dependency to path instead of crates.io version
catsploit_lib = { path = "../catsploit_lib" }
# catsploit_lib = "0.1.0"
</code></pre></div></div>

<h3 id="the-library">The library</h3>
<p>The library consists of all relevant code that is not related directly to user interaction - exploits, payloads, auxiliary modules etc:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[main][~/dev/default/tirax_lab/catsploit/catsploit_lib/src]$ tree .
.
├── core
│   ├── auxiliary.rs
│   ├── exploit
│   │   └── remote_tcp.rs
│   ├── exploit.rs
│   ├── handler
│   │   └── generic_tcp_handler.rs
│   ├── handler.rs
│   ├── opt.rs
│   ├── payload
│   │   └── reverse.rs
│   └── payload.rs
├── core.rs
├── lib.rs
├── module
│   ├── auxiliary
│   │   ├── osint
│   │   │   └── my_ip.rs
│   │   └── osint.rs
│   ├── auxiliary.rs
│   ├── exploit
│   │   ├── ftp
│   │   │   └── vsftpd_234_backdoor.rs
│   │   └── ftp.rs
│   ├── exploit.rs
│   ├── index.rs
│   ├── payload
│   │   ├── linux_shell
│   │   │   └── nc_mkfifo_reverse_tcp.rs
│   │   ├── linux_shell.rs
│   │   ├── ruby
│   │   │   └── ruby_reverse_tcp.rs
│   │   └── ruby.rs
│   └── payload.rs
├── module.rs
├── util
│   └── gen.rs
└── util.rs

14 directories, 25 files
[main][~/dev/default/tirax_lab/catsploit/catsploit_lib/src]$
</code></pre></div></div>

<h4 id="library-core-and-traits">Library core and traits</h4>

<p>In <code class="language-plaintext highlighter-rouge">core</code> we have the logic that defines how the framework works - which are primarily defined with <a href="https://doc.rust-lang.org/book/ch10-02-traits.html">Rust Traits</a>. For example in <code class="language-plaintext highlighter-rouge">exploit.rs</code> we have the <code class="language-plaintext highlighter-rouge">Exploit</code> trait:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">trait</span> <span class="n">Exploit</span> <span class="p">{</span>
    <span class="k">fn</span> <span class="nf">default</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">Self</span>
    <span class="k">where</span>
        <span class="n">Self</span><span class="p">:</span> <span class="n">Sized</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">kind</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Kind</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">ranking</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Ranking</span> <span class="p">{</span>
        <span class="nn">Ranking</span><span class="p">::</span><span class="n">Average</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">payload_compat</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">PayloadCompat</span> <span class="p">{</span>
        <span class="nn">PayloadCompat</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">info</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Info</span><span class="p">;</span>

    <span class="c">// TODO: does payload need to be borrowed box?</span>
    <span class="nd">#[allow(clippy::borrowed_box)]</span>
    <span class="k">fn</span> <span class="nf">exploit</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Payload</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>

    <span class="k">fn</span> <span class="nf">opts</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Opt</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="nb">None</span>
    <span class="p">}</span>

    <span class="k">fn</span> <span class="nf">apply_opts</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">:</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Opt</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this code we define the required methods/functions(see <a href="https://doc.rust-lang.org/book/ch05-03-method-syntax.html#associated-functions">Associated Functions</a>) that a type must have to be able to implement <code class="language-plaintext highlighter-rouge">Exploit</code>. Rust Traits are very similar to Go’s <a href="https://gobyexample.com/interfaces">Interfaces</a>, with the primary difference being that a Rust type will only implement a trait if its defined explicitly <code class="language-plaintext highlighter-rouge">impl Trait for MyStruct</code>, while a Go type will implicitly implement an interface if it happens to have all of the method signatures defined on itself.</p>

<p>Metasploit on the other hand is written in Ruby, which is probably the most OOP language I’ve ever worked with(I don’t really know how to phrase that), with its “everything is an object” philosophy. It uses OOP inheritance to accomplish defining an exploit:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">###</span>
<span class="c1">#</span>
<span class="c1"># The exploit class acts as the base class for all exploit modules.  It</span>
<span class="c1"># provides a common interface for interacting with exploits at the most basic</span>
<span class="c1"># level.</span>
<span class="c1">#</span>
<span class="c1">###</span>
<span class="k">class</span> <span class="nc">Exploit</span> <span class="o">&lt;</span> <span class="no">Msf</span><span class="o">::</span><span class="no">Module</span>

<span class="c1">##</span>
  <span class="c1"># Exceptions</span>
  <span class="c1">##</span>

  <span class="c1"># Indicate that the exploit should abort because it has completed</span>
  <span class="k">class</span> <span class="nc">Complete</span> <span class="o">&lt;</span> <span class="no">RuntimeError</span>
  <span class="k">end</span>

  <span class="c1"># Indicate that the exploit should abort because it has failed</span>
  <span class="k">class</span> <span class="nc">Failed</span> <span class="o">&lt;</span> <span class="no">RuntimeError</span>
  <span class="k">end</span>
<span class="o">...</span>
</code></pre></div></div>

<p>A specific exploit will inherit from the base <code class="language-plaintext highlighter-rouge">Exploit</code> class, which itself inherits from <code class="language-plaintext highlighter-rouge">Msf::Module</code>. The Rust/Go approach could be described as compisition while Ruby uses inheritance. For this use-case of defining what all exploits must be able to do, I think both ways are good solutions.</p>

<p>The reason that an <code class="language-plaintext highlighter-rouge">Exploit</code> trait/class/interface is needed for an exploit framework is so that it can be modular. New exploits are released everyday, and an exploit framework will require a lot of logic to index them, run them, etc. There must be a common interface defined for this so that the a new exploit can be slotted in.</p>

<h4 id="from-a-trait-to-a-working-module">From a trait to a working module</h4>
<p>A new exploit can now be added to the framework by adding a single file, for example <a href="https://github.com/mark-ruddy/catsploit/blob/main/catsploit_lib/src/module/exploit/ftp/vsftpd_234_backdoor.rs">vsftpd_234_backdoor.rs</a>.</p>

<p>In this Rust file, we define a struct on which we define the exploits options and any extra types it needs to complete its work:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">Vsftpd234Backdoor</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">remote_tcp</span><span class="p">:</span> <span class="n">RemoteTcp</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">backdoor_port</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div></div>

<p><a href="https://github.com/mark-ruddy/catsploit/blob/main/catsploit_lib/src/core/exploit/remote_tcp.rs">remote_tcp.rs</a> in the <code class="language-plaintext highlighter-rouge">core</code> of the library provides a type that has functions for opening TCP connections. This is another element of the <code class="language-plaintext highlighter-rouge">core</code> code apart from Traits, extra types that can be shared throughout modules.</p>

<p>In the <code class="language-plaintext highlighter-rouge">vsftpd_234_backdoor.rs</code> file, we can then add whatever extra code we need and importantly explicitly implement the <code class="language-plaintext highlighter-rouge">Exploit</code> trait for the <code class="language-plaintext highlighter-rouge">Vsftpd234Backdoor</code> type:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span> <span class="n">Exploit</span> <span class="k">for</span> <span class="n">Vsftpd234Backdoor</span> <span class="p">{</span>
  <span class="o">...</span>
    <span class="k">fn</span> <span class="nf">exploit</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="k">self</span><span class="p">,</span>
        <span class="n">payload</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Payload</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nn">std</span><span class="p">::</span><span class="nn">error</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">self</span><span class="nf">.attempt_backdoor</span><span class="p">(</span><span class="n">payload</span><span class="nf">.clone</span><span class="p">(),</span> <span class="k">false</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">stream</span> <span class="o">=</span> <span class="k">self</span><span class="py">.remote_tcp</span><span class="nf">.connect</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">stream_buf</span> <span class="o">=</span> <span class="nn">BufReader</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="n">stream</span><span class="nf">.try_clone</span><span class="p">()</span><span class="o">?</span><span class="p">);</span>

        <span class="k">let</span> <span class="k">mut</span> <span class="n">banner_resp</span> <span class="o">=</span> <span class="nn">String</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="n">stream_buf</span><span class="nf">.read_line</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">banner_resp</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="nd">info!</span><span class="p">(</span><span class="s">"Banner returned from server: {}"</span><span class="p">,</span> <span class="n">banner_resp</span><span class="p">);</span>

        <span class="k">let</span> <span class="n">user_hash</span> <span class="o">=</span> <span class="nf">random_alphanumeric</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
        <span class="n">stream</span><span class="nf">.write_all</span><span class="p">(</span><span class="nd">format!</span><span class="p">(</span><span class="s">"USER {}:)</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span> <span class="n">user_hash</span><span class="p">)</span><span class="nf">.as_bytes</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>
        <span class="k">let</span> <span class="k">mut</span> <span class="n">user_hash_resp</span> <span class="o">=</span> <span class="nn">String</span><span class="p">::</span><span class="nf">new</span><span class="p">();</span>
        <span class="n">stream_buf</span><span class="nf">.read_line</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="n">user_hash_resp</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
        <span class="nd">info!</span><span class="p">(</span><span class="s">"Response to user hash: {}"</span><span class="p">,</span> <span class="n">user_hash_resp</span><span class="p">);</span>

        <span class="k">if</span> <span class="n">user_hash_resp</span><span class="nf">.contains</span><span class="p">(</span><span class="s">"530"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span>
                <span class="s">"Server is configured for anonymous only and the backdoor code cannot be reached"</span>
                    <span class="nf">.into</span><span class="p">(),</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="o">!</span><span class="n">user_hash_resp</span><span class="nf">.contains</span><span class="p">(</span><span class="s">"331"</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">Err</span><span class="p">(</span>
                <span class="s">"Server is not responding as expected, response should contain 331 code"</span><span class="nf">.into</span><span class="p">(),</span>
            <span class="p">);</span>
        <span class="p">}</span>
  <span class="o">...</span>
</code></pre></div></div>

<p>With this we have a solid system for defining shared types(like <code class="language-plaintext highlighter-rouge">RemoteTcp</code>) and shared traits(like <code class="language-plaintext highlighter-rouge">Exploit</code>) that modules can easily implement. The <code class="language-plaintext highlighter-rouge">vsftpd_234_backdoor.rs</code> code only contains code directly relevant to the exploit itself and its options. This allows new contributors to open up a PR for a new exploit by slotting in a single file with the exploit code. Of course they will need to hook it all up into the Trait’s methods but that is generally simple enough.</p>

<h4 id="aggregating-modules">Aggregating modules</h4>
<p>So now that we have the <code class="language-plaintext highlighter-rouge">Vsftpd234Backdoor</code> defined, we need some way for applications that use the library to be able to find all the available exploits and use them. This is accomplished with a simple <a href="https://github.com/mark-ruddy/catsploit/blob/main/catsploit_lib/src/module/index.rs">index.rs</a> that has functions which return a <code class="language-plaintext highlighter-rouge">Vec&lt;Box&lt;dyn Trait&gt;&gt;</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">fn</span> <span class="nf">exploits</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Exploit</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="nd">vec!</span><span class="p">[</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">Vsftpd234Backdoor</span><span class="p">::</span><span class="nf">default</span><span class="p">())]</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">payloads</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Payload</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="nd">vec!</span><span class="p">[</span>
        <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">RubyReverseTcp</span><span class="p">::</span><span class="nf">default</span><span class="p">()),</span>
        <span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">NcMkfifoReverseTcp</span><span class="p">::</span><span class="nf">default</span><span class="p">()),</span>
    <span class="p">]</span>
<span class="p">}</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">auxiliary</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Auxiliary</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="nd">vec!</span><span class="p">[</span><span class="nn">Box</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="nn">MyIp</span><span class="p">::</span><span class="nf">default</span><span class="p">())]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>An application can now call these indexing functions and can then do work with the vectors.</p>

<h4 id="using-modules-concurrently">Using modules concurrently</h4>

<p>Note how Payload and Auxiliary have the <code class="language-plaintext highlighter-rouge">+ Send + Sync</code> traits specified when stored in the vector, this is due to them commonly requiring to be called inside threads like such:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">payload</span><span class="nf">.needs_pretask</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="nn">thread</span><span class="p">::</span><span class="nf">spawn</span><span class="p">(</span><span class="k">move</span> <span class="p">||</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">String</span><span class="o">&gt;</span> <span class="p">{</span>
        <span class="n">payload</span><span class="nf">.pretask</span><span class="p">()</span><span class="nf">.map_err</span><span class="p">(|</span><span class="n">e</span><span class="p">|</span> <span class="nd">format!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
    <span class="p">}));</span>
<span class="p">}</span>
</code></pre></div></div>

<p>An example of a pretask, opening up a listener for a reverse shell connection:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">pretask</span><span class="p">(</span><span class="o">&amp;</span><span class="k">self</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="nn">std</span><span class="p">::</span><span class="nn">error</span><span class="p">::</span><span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">handler</span> <span class="o">=</span> <span class="nn">GenericTcpHandler</span><span class="p">::</span><span class="nf">new</span><span class="p">(</span><span class="s">"0.0.0.0"</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">self</span><span class="py">.reverse.lport</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="n">handler</span><span class="nf">.listen_for_one</span><span class="p">(</span><span class="k">false</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
    <span class="nf">Ok</span><span class="p">(())</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Another thread is required when using this payload so that the reverse shell listener pretask does not block the rest of the exploit code from running.</p>

<h3 id="the-cli-application">The CLI application</h3>
<p>The CLI application hooks into the <code class="language-plaintext highlighter-rouge">catsploit_lib</code> library and uses it to provide an interactive CLI program. Metasploit have a similar approach to this(but more advanced, framework can connect to databases etc.), where the <code class="language-plaintext highlighter-rouge">msfconsole</code> is separate from the <code class="language-plaintext highlighter-rouge">metasploit-framework</code>.</p>

<p>It provides a simple, interactive loop for the user to interact with:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[~]$ catsploit

 ________  ________  _________  ________  ________  ___       ________  ___  _________   
|\   ____\|\   __  \|\___   ___\\   ____\|\   __  \|\  \     |\   __  \|\  \|\___   ___\ 
\ \  \___|\ \  \|\  \|___ \  \_\ \  \___|\ \  \|\  \ \  \    \ \  \|\  \ \  \|___ \  \_| 
 \ \  \    \ \   __  \   \ \  \ \ \_____  \ \   ____\ \  \    \ \  \\\  \ \  \   \ \  \  
  \ \  \____\ \  \ \  \   \ \  \ \|____|\  \ \  \___|\ \  \____\ \  \\\  \ \  \   \ \  \ 
   \ \_______\ \__\ \__\   \ \__\  ____\_\  \ \__\    \ \_______\ \_______\ \__\   \ \__\
    \|_______|\|__|\|__|    \|__| |\_________\|__|     \|_______|\|_______|\|__|    \|__|
                                  \|_________|                                           
            
---------------------
 Module Type  Loaded 
---------------------
 Exploits     1 
---------------------
 Payloads     2 
---------------------
catsploit&gt; show payloads
+---+-------------------------------------------+---------------------------+--------------+
| # | Module Path                               | Name                      | Kind         |
+---+-------------------------------------------+---------------------------+--------------+
| 0 | payload/ruby/reverse_tcp                  | Ruby Reverse TCP          | ReverseShell |
+---+-------------------------------------------+---------------------------+--------------+
| 1 | payload/linux_shell/nc_mkfifo_reverse_tcp | Netcat Mkfifo Reverse TCP | ReverseShell |
+---+-------------------------------------------+---------------------------+--------------+
catsploit&gt; use 0
catsploit (payload/ruby/reverse_tcp)&gt; info   
+------------------+--------------------------+--------------+
| Name             | Module Path              | Kind         |
+------------------+--------------------------+--------------+
| Ruby Reverse TCP | payload/ruby/reverse_tcp | ReverseShell |
+------------------+--------------------------+--------------+
+-------+---------------+---------+---------+
| Name  | Description   | Default | Current |
+-------+---------------+---------+---------+
| LHOST | Listener host | 0.0.0.0 | 0.0.0.0 |
+-------+---------------+---------+---------+
| LPORT | Listener port | 9092    | 9092    |
+-------+---------------+---------+---------+
catsploit (payload/ruby/reverse_tcp)&gt; set LHOST 192.168.1.1
</code></pre></div></div>

<h4 id="interactive-cli">Interactive CLI</h4>
<p>An interactive CLI is relatively simple to implement. The complexity comes from holding state(e.g. Which exploit has the user currently selected? What options have they set to what values?).</p>

<p>The below code in the <code class="language-plaintext highlighter-rouge">main</code> function of the CLI app is enough to provide the interactive CLI loop:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">main</span><span class="p">()</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="nn">env_logger</span><span class="p">::</span><span class="nn">Builder</span><span class="p">::</span><span class="nf">from_env</span><span class="p">(</span><span class="nn">env_logger</span><span class="p">::</span><span class="nn">Env</span><span class="p">::</span><span class="nf">default</span><span class="p">()</span><span class="nf">.default_filter_or</span><span class="p">(</span><span class="s">"info"</span><span class="p">))</span><span class="nf">.init</span><span class="p">();</span>

    <span class="k">let</span> <span class="k">mut</span> <span class="n">cli</span> <span class="o">=</span> <span class="nn">Cli</span><span class="p">::</span><span class="nf">default</span><span class="p">();</span>
    <span class="n">cli</span><span class="nf">.print_banner</span><span class="p">();</span>
    <span class="n">cli</span><span class="nf">.print_module_stats</span><span class="p">();</span>
    <span class="k">loop</span> <span class="p">{</span>
        <span class="n">cli</span><span class="nf">.print_prompt</span><span class="p">();</span>
        <span class="nn">io</span><span class="p">::</span><span class="nf">stdout</span><span class="p">()</span><span class="nf">.flush</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>

        <span class="k">let</span> <span class="n">user_input</span> <span class="o">=</span> <span class="k">match</span> <span class="n">cli</span><span class="nf">.get_user_input</span><span class="p">()</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">user_input</span><span class="p">,</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="k">match</span> <span class="n">cli</span><span class="nf">.handle_input</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">Ok</span><span class="p">(</span><span class="n">prompt_change</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="n">prompt_change</span><span class="p">,</span>
            <span class="nf">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"{}"</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="holding-cli-state-in-memory">Holding CLI state in memory</h4>

<p>The approach I’ve chosen for this is something close to OOP, which in Rust’s case is a struct type with methods defined on it. The <code class="language-plaintext highlighter-rouge">Cli</code> struct is defined with all the state it needs, with all of them put inside <code class="language-plaintext highlighter-rouge">Option</code> so they can each be <code class="language-plaintext highlighter-rouge">None</code> or <code class="language-plaintext highlighter-rouge">Some(T)</code>:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">pub</span> <span class="k">struct</span> <span class="n">Cli</span> <span class="p">{</span>
    <span class="k">pub</span> <span class="n">prompt</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">selected_module_kind</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Kind</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">selected_module_path</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">selected_module_opts</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Opt</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">previous_module_opts</span><span class="p">:</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span> <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Opt</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">displayed_list</span><span class="p">:</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">usize</span><span class="p">,</span> <span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>

    <span class="k">pub</span> <span class="n">auxiliary</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Auxiliary</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">auxiliary_info</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">auxiliary</span><span class="p">::</span><span class="n">Info</span><span class="o">&gt;</span><span class="p">,</span>

    <span class="k">pub</span> <span class="n">exploit</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Exploit</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">exploit_info</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">exploit</span><span class="p">::</span><span class="n">Info</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">exploit_payload</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Payload</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;&gt;</span><span class="p">,</span>

    <span class="k">pub</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Payload</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;&gt;</span><span class="p">,</span>
    <span class="k">pub</span> <span class="n">payload_info</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">payload</span><span class="p">::</span><span class="n">Info</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Then the <code class="language-plaintext highlighter-rouge">Cli</code> struct is used in a lot of different methods that take it as <code class="language-plaintext highlighter-rouge">&amp;mut self</code>. This is a mutable reference to the instance/object of the <code class="language-plaintext highlighter-rouge">Cli</code> struct. Each of the below called methods can update the state of the <code class="language-plaintext highlighter-rouge">Cli</code>, change a value like <code class="language-plaintext highlighter-rouge">exploit_info</code> to <code class="language-plaintext highlighter-rouge">None</code> or <code class="language-plaintext highlighter-rouge">Some(exploit::Info)</code> and so on:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">impl</span> <span class="n">Cli</span> <span class="p">{</span>
  <span class="o">...</span>
    <span class="k">pub</span> <span class="k">fn</span> <span class="nf">handle_input</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span> <span class="k">self</span><span class="p">,</span> <span class="n">input</span><span class="p">:</span> <span class="n">UserInput</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">Result</span><span class="o">&lt;</span><span class="p">(),</span> <span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Error</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">match</span> <span class="n">input</span><span class="py">.cmd</span><span class="nf">.as_str</span><span class="p">()</span> <span class="p">{</span>
            <span class="s">"modules"</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="nf">.print_module_stats</span><span class="p">(),</span>
            <span class="s">"show"</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="nf">.handle_show</span><span class="p">(</span><span class="n">input</span><span class="py">.subcmd</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
            <span class="s">"info"</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="nf">.handle_info</span><span class="p">(</span><span class="n">input</span><span class="py">.subcmd</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
            <span class="s">"use"</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="nf">.handle_use</span><span class="p">(</span><span class="n">input</span><span class="py">.subcmd</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
            <span class="s">"set"</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="nf">.handle_set</span><span class="p">(</span><span class="n">input</span><span class="py">.subcmd</span><span class="p">,</span> <span class="n">input</span><span class="py">.args</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
            <span class="s">"run"</span> <span class="k">=&gt;</span> <span class="k">self</span><span class="nf">.handle_run</span><span class="p">()</span><span class="o">?</span><span class="p">,</span>
            <span class="s">"help"</span> <span class="k">=&gt;</span> <span class="nn">Cli</span><span class="p">::</span><span class="nf">handle_help</span><span class="p">(),</span>
            <span class="s">"exit"</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="nd">println!</span><span class="p">(</span><span class="s">"Exiting..."</span><span class="p">);</span>
                <span class="nn">process</span><span class="p">::</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="mi">_</span> <span class="k">=&gt;</span> <span class="p">{</span>
                <span class="k">if</span> <span class="o">!</span><span class="n">input</span><span class="py">.cmd</span><span class="nf">.is_empty</span><span class="p">()</span> <span class="p">{</span>
                    <span class="nd">println!</span><span class="p">(</span><span class="s">"Unknown command '{}'"</span><span class="p">,</span> <span class="n">input</span><span class="py">.cmd</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">};</span>
        <span class="nf">Ok</span><span class="p">(())</span>
    <span class="p">}</span>
  <span class="o">...</span>
</code></pre></div></div>

<p>This provides a concise, in-memory and in-code way of storing state for an application such as this. A mistake I’ve made in the past is attempting to store state similar to this in parameters and return values instead of inside a struct/class. Both the caller and callee code can become messy quickly and the same parameters may be required for multiple functions:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">fn</span> <span class="nf">change_exploits</span><span class="p">(</span><span class="n">exploits</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Exploit</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">exploit_info</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nn">exploit</span><span class="p">::</span><span class="n">Info</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">exploit_payload</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Payload</span> <span class="o">+</span> <span class="nb">Send</span> <span class="o">+</span> <span class="n">Sync</span><span class="o">&gt;&gt;</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="n">OptionVec</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Exploit</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// do something with exploits and return them</span>
    <span class="k">return</span> <span class="nf">Some</span><span class="p">(</span><span class="n">updated_exploits</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">let</span> <span class="n">updated_exploits</span> <span class="o">=</span> <span class="nf">change_exploits</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="nf">.unwrap</span><span class="p">()</span>
</code></pre></div></div>

<p>For a system managing hundreds or thousands of pieces of state information, it may make sense to look instead for an out-of-code way of storing it such as SQLite etc. I believe its generally fine to just store state in-memory when its reasonable, and especially when it allows your application to forgo requiring a dependency such as a database.</p>

<h4 id="hooking-into-the-library">Hooking into the library</h4>
<p>The code for hooking into the <code class="language-plaintext highlighter-rouge">catsploit_lib</code> library is actually very simple:</p>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">use</span> <span class="nn">catsploit_lib</span><span class="p">::</span><span class="nn">module</span><span class="p">::{</span><span class="n">index</span><span class="p">,</span> <span class="n">Kind</span><span class="p">};</span>

<span class="o">...</span>

<span class="k">pub</span> <span class="k">fn</span> <span class="nf">find_exploit</span><span class="p">(</span><span class="n">module_path</span><span class="p">:</span> <span class="o">&amp;</span><span class="nb">str</span><span class="p">)</span> <span class="k">-&gt;</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Exploit</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">let</span> <span class="n">exploits</span> <span class="o">=</span> <span class="nn">index</span><span class="p">::</span><span class="nf">exploits</span><span class="p">();</span>
    <span class="k">let</span> <span class="k">mut</span> <span class="n">selected_exploit</span><span class="p">:</span> <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="n">dyn</span> <span class="n">Exploit</span><span class="o">&gt;&gt;</span> <span class="o">=</span> <span class="nb">None</span><span class="p">;</span>
    <span class="k">for</span> <span class="n">exploit</span> <span class="n">in</span> <span class="n">exploits</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">exploit</span><span class="nf">.info</span><span class="p">()</span><span class="py">.module_path</span> <span class="o">==</span> <span class="n">module_path</span> <span class="p">{</span>
            <span class="n">selected_exploit</span> <span class="o">=</span> <span class="nf">Some</span><span class="p">(</span><span class="n">exploit</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">selected_exploit</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this application-side code the exploit index is from the library is called, and then iterated through to find which one matches a specific module path. With this code the CLI application can grab a specific exploit requested by the user, and then call any of the <code class="language-plaintext highlighter-rouge">Exploit</code> trait methods on it such as <code class="language-plaintext highlighter-rouge">exploit()</code> to run it.</p>

<p>From this we can see how this library could be used in any Rust code - for example an <code class="language-plaintext highlighter-rouge">axum</code> webserver could be written were a user visits a webapp that allows them to view the exploits and run them.</p>

<h2 id="exploit-frameworks-are-momentum-based">Exploit frameworks are momentum based</h2>
<p>As seen by the description of the code for an exploit framework, it is clear that they rely on modules. Everyday new exploits are developed for new vulnerabilities, new payloads techniques are developed, new scanners, etc. Without an extensive open-source community and full-time employees behind it to write new modules on a regular basis the framework will rapidly become outdated.</p>

<p>When it comes to fuzzing tools for example you have a lot of quality tools to choose from: <code class="language-plaintext highlighter-rouge">ffuf</code>, <code class="language-plaintext highlighter-rouge">wfuzz</code>, <code class="language-plaintext highlighter-rouge">fuzzapi</code>, <code class="language-plaintext highlighter-rouge">boofuzz</code>, <code class="language-plaintext highlighter-rouge">syzkaller</code> and you could go on and on. Many of these tools are not super actively developed either, as they often don’t need to be, once they’re written and tested they can work well for years. This is not the case for exploit frameworks.</p>

<p>For a generalists open-source exploit framework, realistically <code class="language-plaintext highlighter-rouge">metasploit-framework</code> is the only option. There are a few other closed-source ones such as <code class="language-plaintext highlighter-rouge">CORE IMPACT</code>, <code class="language-plaintext highlighter-rouge">Immunity CANVAS</code>, or browser exploitation frameworks such as <code class="language-plaintext highlighter-rouge">BEeF</code>.</p>

<p>None of these cover the same breadth of Metasploit though, and I believe it would be nearly impossible to do so - the project has the most momentum in a field that relies on that.</p>

<h2 id="conclusion">Conclusion</h2>
<p>Catsploit was a fun project to work on and develop, I learned a ton about Rust, Ruby, Exploits, Payloads and more. On reflection though  without constant work the project can never actually be useful to anyone, which is fine :)</p>


    </div>

</article>
<div class="post-nav"><span></span><span></span></div><div class="post-related">
      <div>Related Articles</div>
      <ul>
        <li><a class="post-link" href="/markdown/2023/05/07/developing-a-metasploit-alternative-catsploit.html" title="">Developing a Metasploit Alternative - Catsploit</a></li></ul>
    </div><div class="post-comments"></div></section>
</div>


  </section>
  <section class="sidebar" style="margin-left: 15px;">
    <!-- Get sidebar items --><style type="text/css" media="screen">
.post-menu ul {
  list-style: none;
  padding: 0;
  margin: 0;
}
</style>

<div class="post-menu">
  <div class="post-menu-title">TOC</div>
  <div class="post-menu-content"></div>
</div>

<script>
  function generateContent() {
    var menu = document.querySelector(".post-menu");
    var menuContent =  menu.querySelector(".post-menu-content");
    var headings = document.querySelector(".post-content").querySelectorAll("h2, h3, h4, h5, h6");

    // Hide menu when no headings
    if (headings.length === 0) {
      return menu.style.display = "none";
    }

    // Generate post menu
    var menuHTML = '';
    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      menuHTML += (
        '<li class="h-' + h.tagName.toLowerCase() + '">'
        + '<a href="#h-' + h.getAttribute('id') + '">' + h.textContent + '</a></li>');
    }

    menuContent.innerHTML = '<ul>' + menuHTML + '</ul>';

    // The header element
    var header = document.querySelector('header.site-header');

    function doMenuCollapse(index, over_items) {
      var items = menuContent.firstChild.children;

      if (over_items == undefined) {
        over_items = 20;
      }

      if (items.length < over_items) {
        return;
      }

      var activeItem = items[index];
      var beginItem = activeItem
      var endItem = activeItem
      var beginIndex = index;
      var endIndex = index + 1;
      while (beginIndex >= 0
        && !items[beginIndex].classList.contains('h-h2')) {
        beginIndex -= 1;
      }
      while (endIndex < items.length
        && !items[endIndex].classList.contains('h-h2')) {
        endIndex += 1;
      }
      for (var i = 0; i < beginIndex; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
      for (var i = beginIndex + 1; i < endIndex; i++) {
        item = items[i]
        // if (!item.classList.contains('h-h2')) {
          item.style.display = '';
        // }
      }
      for (var i = endIndex; i < items.length; i++) {
        item = items[i]
        if (!item.classList.contains('h-h2')) {
          item.style.display = 'none';
        }
      }
    }

    // Init menu collapsed
    doMenuCollapse(-1);

    // Active the menu item
    window.addEventListener('scroll', function (event) {
      var lastActive = menuContent.querySelector('.active');
      var changed = true;
      var activeIndex = -1;
      for (var i = headings.length - 1; i >= 0; i--) {
        var h = headings[i];
        var headingRect = h.getBoundingClientRect();
        var headerRect = header.getBoundingClientRect();
        var headerTop = Math.floor(headerRect.top);
        var headerHeight = Math.floor(headerRect.height);
        var headerHeight = headerTop + headerHeight + 20;
        if (headingRect.top <= headerHeight) {
          var id = 'h-' + h.getAttribute('id');
          var a = menuContent.querySelector('a[href="#' + id  + '"]');
          var curActive = a.parentNode;
          if (curActive) {
            curActive.classList.add('active');
            activeIndex = i;
          }
          if (lastActive == curActive) {
            changed = false;
          }
          break;
        }
      }
      if (changed) {
        if (lastActive) {
          lastActive.classList.remove('active');
        }
        doMenuCollapse(activeIndex);
      }
      event.preventDefault();
    });
  }
  generateContent();
</script>
</section>
</div>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">
    <div class="site-footer-inner"><div></div>
      <div>Powered by <a title="Jekyll is a simple, blog-aware, static site
      generator." href="https://jekyllrb.com/">Jekyll</a> &amp; <a title="Yat, yet
      another theme." href="https://github.com/jeffreytse/jekyll-theme-yat">Yat Theme</a>.</div>
      <div class="footer-col rss-subscribe">Subscribe <a href="/feed.xml">via RSS</a></div>
    </div>
  </div>
</footer>
</body>
</html>
